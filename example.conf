
worker_processes  1;
daemon off;
error_log stderr debug;
events {
	worker_connections 1024;
}

http {
	lua_package_path '/Users/philips/coreos/ngx-etcd/lib/?.lua;;';
	server {
		listen 8080;

		location / {
			set $_url "";
			set $best_upstream "";

			access_by_lua '
				local init = require("coreinit")
				local i = init:new("http://192.168.240.151:4001")
				local unit = i:unit("sshd.service")
				local machines, err = unit:machines()
				if err ~= nil then
					ngx.say(err.errorCode)
				end
				if machines ~= nil then
					local addr = machines[1]:addrs()[1].addr
					addr = string.match(addr, "(.+)/")
					-- TODO: dont hardcode the port
					ngx.var.best_upstream = addr .. ":8000"
					print(ngx.var.best_upstream)
				end
			';

			proxy_pass http://$best_upstream;
		}

		location /proxy {
			internal;
			rewrite_by_lua "
			  local req = ngx.req

			  for k,v in pairs(req.get_headers()) do
			    if k ~= 'content-length' then
			      req.clear_header(k)
			    end
			  end

			  if ngx.ctx.headers then
			    for k,v in pairs(ngx.ctx.headers) do
			      req.set_header(k, v)
			    end
			  end
			";

			resolver 8.8.8.8;
			proxy_http_version 1.1;
			proxy_pass $_url;
		}
	}
}
